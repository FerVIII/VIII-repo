name: Build & Publish Kodi Repo

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Validate addon.xml
        run: |
          if [ ! -f plugin.video.viiiiptv/addon.xml ]; then
            echo "❌ addon.xml no encontrado"
            exit 1
          fi
          echo "✅ addon.xml encontrado"

      - name: Package Addon
        run: |
          zip -r plugin.video.viiiiptv-${GITHUB_REF_NAME}.zip plugin.video.viiiiptv

      - name: Generate addons.xml
        run: |
          echo '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>' > addons.xml
          echo '<addons>' >> addons.xml
          xmllint --format plugin.video.viiiiptv/addon.xml >> addons.xml
          echo '</addons>' >> addons.xml

      - name: Generate addons.xml.md5
        run: |
          md5sum addons.xml | awk '{ print $1 }' > addons.xml.md5

      - name: Upload to GitHub Pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          keep_files: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: plugin.video.viiiiptv-${GITHUB_REF_NAME}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
